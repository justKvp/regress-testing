pipeline {

    agent any

    parameters {
        string(name: 'config', defaultValue: 'default', description: 'YAML config for run')
        string(name: 'tags', defaultValue: 'run', description: 'List of tags for running')
    }

    stages {
        stage('Run Tests') {

            steps('run docker image') {
                // This step should not normally be used in your script. Consult the inline help for details.
                //withDockerContainer(image: 'qvipka/playwright-1.45.0:latest') {
                //    sh './mvnw -Dconfig=$config -Dgroups=tags clean test'
                //}

                sh './mvnw -Dconfig=$config -Dgroups=$tags clean test'
            }

        }
    }

    post {
        always {
            script {
                /** Сначала в любом случае генерим аллюр-отчет **/
                allure([
                   includeProperties: false,
                   jdk: '',
                   properties: [],
                   reportBuildPolicy: 'ALWAYS',
                   results: [[path: 'target/allure-results']]
                ])

                /** Затягиваем данные из результатов **/
                junit 'target/surefire-reports/*.xml'

                /** Отправляем отчет на почту **/
                withCredentials([usernamePassword(credentialsId: 'qvipka', usernameVariable: 'EMAIL_LOGIN', passwordVariable: 'EMAIL_PASSWORD')]) {
                    callAllureNotification(JOB_NAME, BUILD_URL, EMAIL_LOGIN, EMAIL_PASSWORD);
                }
            }
        }
    }
}

def callAllureNotification(String jobName, String url, String login, String password) {
    createConfig(jobName, url, login, password)
    sh 'java "-DconfigFile=notifications/config.json" -jar notifications/allure-notifications-4.7.0.jar'
    deleteConfig()
}

def createConfig(String jobName, String url, String login, String password) {
    echo jobName
    echo url
    echo login
    Boolean bol = password.equals("hxjg ntot nfnh cqss")
    echo bol
    String body = '{\n' +
            '  "base": {\n' +
            '    "logo": "logo.png",\n' +
            '    "project": ${jobName},\n' +
            '    "environment": "some env",\n' +
            '    "comment": "some comment",\n' +
            '    "reportLink": ${url},\n' +
            '    "language": "ru",\n' +
            '    "allureFolder": "allure-report",\n' +
            '    "enableChart": true,\n' +
            '    "enableSuitesPublishing": true\n' +
            '  },\n' +
            '  "mail": {\n' +
            '    "host": "smtp.gmail.com",\n' +
            '    "port": "465",\n' +
            '    "username": ${login},\n' +
            '    "password": ${password},\n' +
            '    "securityProtocol": "SSL",\n' +
            '    "from": "qvipka@gmail.com",\n' +
            '    "recipient": "va_90@mail.ru",\n' +
            '    "templatePath": "/templates/html.ftl"\n' +
            '  }\n' +
            '}';

    writeFile file: 'notifications/config.json', text: body
}

def deleteConfig() {
    sh 'rm notifications/config.json'
}