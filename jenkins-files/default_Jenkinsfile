pipeline {

    agent any

    parameters {
        choice(name: 'browser', choices: ['chromium', 'firefox', 'webkit'], description: 'Выберите браузер для прогона')
        string(name: 'email', defaultValue: '', description: 'Email address for receive report')
    }

    stages {
        stage('Run Tests') {

            steps('run docker image') {
                // This step should not normally be used in your script. Consult the inline help for details.
                withDockerContainer(image: 'qvipka/playwright-1.45.0:latest') {
                    sh './mvnw -Dmaven.repo.local=/tmp/mvn-repo -Dbrowser=$browser clean test'
                }
            }

        }
    }

    post {
        always {
            script {

                /** Сначала в любом случае генерим аллюр-отчет **/
                allure([
                   includeProperties: false,
                   jdk: '',
                   properties: [],
                   reportBuildPolicy: 'ALWAYS',
                   results: [[path: 'target/allure-results']]
                ])

                /** Затягиваем данные из результатов **/
                junit 'target/surefire-reports/*.xml'

                /** Отправляем на почту **/
                callAllureNotification();
              }
        }
    }
}

def callAllureNotification() {
    String command = 'java  ' +
            '"-Dmessenger=email" ' +

            '"-Dmail.host=smtp.gmail.com" ' +
            '"-Dmail.port=465" ' +
            '"-Dmail.username=qvipka" ' +
            '"-Dmail.password=hxjg ntot nfnh cqss" ' +
            '"-Dmail.securityProtocol=SSL" ' +
            '"-Dmail.recipient=va_90@mail.ru" ' +
            '"-Dmail.templatePath=/templates/html.ftl" ' +

            '"-Dlogo=logo.png" ' +
            '"-Dproject=${JOB_BASE_NAME}" ' +
            '"-Denvironment=some env" ' +
            '"-Dcomment=some comment" ' +
            '"-DreportLink=some link" ' +
            '"-Dlanguage=ru" ' +
            '"-DallureFolder=target/allure-report" ' +
            '"-DenableChart=true" ' +
            '"-DenableSuitesPublishing=true" ' +

            '-jar ./notifications/allure-notifications-4.7.0.jar';
    sh command;
}