pipeline {

    agent any

    parameters {
        string(name: 'config', defaultValue: 'default', description: 'YAML config for run')
        string(name: 'tags', defaultValue: 'run', description: 'List of tags for running')
    }

    stages {
        stage('Run Tests') {

            steps('run docker image') {
                // This step should not normally be used in your script. Consult the inline help for details.
                //withDockerContainer(image: 'qvipka/playwright-1.45.0:latest') {
                //    sh './mvnw -Dconfig=$config -Dgroups=tags clean test'
                //}

                sh './mvnw -Dconfig=$config -Dgroups=$tags clean test'
            }

        }
    }

    post {
        always {
            script {

                /** Сначала в любом случае генерим аллюр-отчет **/
                allure([
                   includeProperties: false,
                   jdk: '',
                   properties: [],
                   reportBuildPolicy: 'ALWAYS',
                   results: [[path: 'target/allure-results']]
                ])

                /** Затягиваем данные из результатов **/
                junit 'target/surefire-reports/*.xml'

                /** Генерим отчет для allure-notifications **/
                sh 'allure generate target/allure-results -o target/allure-report'

                /** Отправляем отчет на почту **/
                callAllureNotification();
              }
        }
    }
}

def callAllureNotification() {
    String command = 'java  ' +
            '"-Dmessenger=email" ' +

            '"-Dmail.host=smtp.gmail.com" ' +
            '"-Dmail.port=465" ' +
            '"-Dmail.username=qvipka" ' +
            '"-Dmail.password=hxjg ntot nfnh cqss" ' +
            '"-Dmail.securityProtocol=SSL" ' +
            '"-Dmail.recipient=va_90@mail.ru" ' +
            '"-Dmail.templatePath=/templates/html.ftl" ' +

            '"-Dlogo=logo.png" ' +
            '"-Dproject=${JOB_BASE_NAME}" ' +
            '"-Denvironment=some env" ' +
            '"-Dcomment=some comment" ' +
            '"-DreportLink=some link" ' +
            '"-Dlanguage=ru" ' +
            '"-DallureFolder=target/allure-report" ' +
            '"-DenableChart=true" ' +
            '"-DenableSuitesPublishing=true" ' +

            '-jar ./notifications/allure-notifications-4.7.0.jar';
    sh '$command';
}